name: Build Apk Auto Session

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build Android APK
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.29.1'
          cache: true

      - name: Flutter dependencies
        run: flutter pub get

#      - name: Run tests
#        run: flutter test

#      - name: Decode keystore
#        run: |
#          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Build APK
        run: flutter build apk
#        env:
#          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
#          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
#          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

#      - name: Build signed AppBundle
#        run: flutter build appbundle  --release
#        env:
#          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
#          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
#          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Extract app version
        id: app_version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Rename artifacts
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/autoBuild_v${{ steps.app_version.outputs.version }}.apk
          
#          mv build/app/outputs/bundle/release/app-release.aab \
#             build/app/outputs/bundle/release/autoBuild_v${{ steps.app_version.outputs.version }}.aab


      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: autoBuild_v${{ steps.app_version.outputs.version }}_apk
          path: build/app/outputs/flutter-apk/autoBuild_v${{ steps.app_version.outputs.version }}.apk

#      # ðŸ“¦ Upload AAB
#      - name: Upload AAB
#        uses: actions/upload-artifact@v4
#        with:
#          name: autoBuild_v${{ steps.app_version.outputs.version }}_aab
#          path: build/app/outputs/bundle/release/autoBuild_v${{ steps.app_version.outputs.version }}.aab

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.app_version.outputs.version }}
          name: AutoBuild v${{ steps.app_version.outputs.version }}
          body: |
            âœ… Android build ready
            
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}

          files: |
            build/app/outputs/flutter-apk/autoBuild_v${{ steps.app_version.outputs.version }}.apk
#            build/app/outputs/bundle/release/autoBuild_v${{ steps.app_version.outputs.version }}.aab

      - name: Send APK email notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}

          subject: >
            âœ… Android APK ${{ job.status }} â€“ Auto Build Apk

          to: ${{ secrets.EMAIL_TO_APK }}
          from: Auto Build Apk CI <${{ secrets.SMTP_USERNAME }}>

          body: |
            Hello ðŸ‘‹,
            I am CI/CD Bot ðŸ¤–. I am guided to deliver the apk once ready by the Developer.
            
            âœ… Build Status: ${{ job.status }}
            ðŸ“± App: Auto Build Apk
            ðŸ”¢ Build Number: ${{ github.run_number }}

            â¬‡ Direct Downloads:
              APK:
              https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/app-release.apk

            ðŸ“¦ Public Downloads:
            https://github.com/${{ github.repository }}/releases

            ðŸ”— GitHub Run Details:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ðŸ“¦ Find Apk Here :
            https://github.com/${{ github.repository }}/releases
            
            Regards,
            Satyam Ojha
            Mobile Application Engineer

#      - name: Send Bundle email notification
#        if: success()
#        uses: dawidd6/action-send-mail@v3
#        with:
#          server_address: smtp.gmail.com
#          server_port: 587
#          username: ${{ secrets.SMTP_USERNAME }}
#          password: ${{ secrets.SMTP_PASSWORD }}
#
#          subject: >
#            âœ… Android Bundle ${{ job.status }} â€“ Auto Build Apk
#
#          to: ${{ secrets.EMAIL_TO_BUNDLE }}
#          from: Auto Build Apk CI <${{ secrets.SMTP_USERNAME }}>
#
#          body: |
#            Hello ðŸ‘‹,
#            I am CI/CD Bot ðŸ¤–. This is Your Bundle for upload on Play Store
#
#            âœ… Build Status: ${{ job.status }}
#            ðŸ“± App: Auto Build Apk
#            ðŸŒ¿ Branch: ${{ github.ref_name }}
#
#            ðŸ”— GitHub Run:
#            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
#
#            ðŸ“¦ Artifacts:
#            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
#
#            â¬‡ Direct Downloads:
#              APK:
#              https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/app-release.apk
#
#              Bundle:
#              https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/app-release.aab
#
#
#            Regards,
#            Satyam Ojha
#            Mobile Application Engineer

